-- Library Management System - Complete SQL Code
CREATE DATABASE IF NOT EXISTS library_management_system;
USE library_management_system;

-- Members Table
CREATE TABLE Members (
    member_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(15),
    membership_date DATE NOT NULL,
    status ENUM('Active', 'Inactive') DEFAULT 'Active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Books Table
CREATE TABLE Books (
    book_id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(100) NOT NULL,
    genre VARCHAR(50),
    published_year YEAR,
    isbn VARCHAR(20) UNIQUE,
    total_copies INT DEFAULT 1,
    available_copies INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Transactions Table
CREATE TABLE Transactions (
    transaction_id INT AUTO_INCREMENT PRIMARY KEY,
    book_id INT NOT NULL,
    member_id INT NOT NULL,
    issue_date DATE NOT NULL,
    due_date DATE NOT NULL,
    return_date DATE NULL,
    fine_amount DECIMAL(8,2) DEFAULT 0.00,
    status ENUM('Issued', 'Returned', 'Overdue') DEFAULT 'Issued',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (book_id) REFERENCES Books(book_id),
    FOREIGN KEY (member_id) REFERENCES Members(member_id)
);

-- Insert Sample Members
INSERT INTO Members (full_name, email, phone, membership_date, status) VALUES
('Rahul Sharma', 'rahul.sharma@email.com', '9876543210', '2024-01-15', 'Active'),
('Priya Singh', 'priya.singh@email.com', '9876543211', '2024-02-20', 'Active'),
('Amit Kumar', 'amit.kumar@email.com', '9876543212', '2024-01-10', 'Active'),
('Neha Gupta', 'neha.gupta@email.com', '9876543213', '2024-03-05', 'Inactive'),
('Raj Patel', 'raj.patel@email.com', '9876543214', '2024-02-28', 'Active');

-- Insert Sample Books
INSERT INTO Books (title, author, genre, published_year, isbn, total_copies, available_copies) VALUES
('The Alchemist', 'Paulo Coelho', 'Fiction', 1988, '978-0061122415', 5, 3),
('Wings of Fire', 'A.P.J. Abdul Kalam', 'Autobiography', 1999, '978-8173711466', 3, 2),
('The God of Small Things', 'Arundhati Roy', 'Fiction', 1997, '978-0679457312', 4, 4),
('The White Tiger', 'Aravind Adiga', 'Fiction', 2008, '978-1416562597', 2, 1),
('Mathematics for Class 10', 'R.D. Sharma', 'Education', 2020, '978-8192893231', 10, 8),
('Computer Fundamentals', 'P.K. Sinha', 'Technology', 2018, '978-8176567527', 6, 5);

-- Insert Sample Transactions
INSERT INTO Transactions (book_id, member_id, issue_date, due_date, return_date, fine_amount, status) VALUES
(1, 1, '2024-03-01', '2024-03-15', '2024-03-14', 0.00, 'Returned'),
(2, 2, '2024-03-05', '2024-03-19', NULL, 50.00, 'Overdue'),
(3, 3, '2024-03-10', '2024-03-24', NULL, 0.00, 'Issued'),
(4, 1, '2024-03-12', '2024-03-26', NULL, 0.00, 'Issued'),
(1, 4, '2024-02-20', '2024-03-05', '2024-03-10', 25.00, 'Returned');

-- Procedure to Issue a Book
DELIMITER $$
CREATE PROCEDURE IssueBook(
    IN p_member_id INT,
    IN p_book_id INT,
    IN p_issue_date DATE
)
BEGIN
    DECLARE available_count INT;
    DECLARE due_date DATE;
    
    SELECT available_copies INTO available_count 
    FROM Books WHERE book_id = p_book_id;
    
    IF available_count > 0 THEN
        SET due_date = DATE_ADD(p_issue_date, INTERVAL 14 DAY);
        
        INSERT INTO Transactions (book_id, member_id, issue_date, due_date, status)
        VALUES (p_book_id, p_member_id, p_issue_date, due_date, 'Issued');
        
        UPDATE Books 
        SET available_copies = available_copies - 1 
        WHERE book_id = p_book_id;
        
        SELECT 'Book issued successfully' AS message;
    ELSE
        SELECT 'Book not available' AS message;
    END IF;
END$$
DELIMITER ;

-- Procedure to Return a Book
DELIMITER $$
CREATE PROCEDURE ReturnBook(
    IN p_transaction_id INT,
    IN p_return_date DATE
)
BEGIN
    DECLARE v_book_id INT;
    DECLARE v_due_date DATE;
    DECLARE v_fine_amount DECIMAL(8,2);
    
    SELECT book_id, due_date INTO v_book_id, v_due_date
    FROM Transactions WHERE transaction_id = p_transaction_id;
    
    IF p_return_date > v_due_date THEN
        SET v_fine_amount = DATEDIFF(p_return_date, v_due_date) * 10;
    ELSE
        SET v_fine_amount = 0;
    END IF;
    
    UPDATE Transactions 
    SET return_date = p_return_date,
        fine_amount = v_fine_amount,
        status = 'Returned'
    WHERE transaction_id = p_transaction_id;
    
    UPDATE Books 
    SET available_copies = available_copies + 1 
    WHERE book_id = v_book_id;
    
    SELECT CONCAT('Book returned successfully. Fine: â‚¹', v_fine_amount) AS message;
END$$
DELIMITER ;

-- Function to Calculate Total Fine for a Member
DELIMITER $$
CREATE FUNCTION CalculateTotalFine(p_member_id INT) 
RETURNS DECIMAL(8,2)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE total_fine DECIMAL(8,2);
    
    SELECT COALESCE(SUM(fine_amount), 0) INTO total_fine
    FROM Transactions 
    WHERE member_id = p_member_id AND fine_amount > 0;
    
    RETURN total_fine;
END$$
DELIMITER ;

-- Views
CREATE VIEW CurrentIssuedBooks AS
SELECT 
    t.transaction_id,
    m.full_name AS member_name,
    b.title AS book_title,
    t.issue_date,
    t.due_date,
    t.status
FROM Transactions t
JOIN Members m ON t.member_id = m.member_id
JOIN Books b ON t.book_id = b.book_id
WHERE t.return_date IS NULL AND t.status != 'Returned';

CREATE VIEW LibraryStats AS
SELECT 
    COUNT(*) AS total_books,
    SUM(total_copies) AS total_copies,
    SUM(available_copies) AS available_copies,
    (SELECT COUNT(*) FROM Members WHERE status = 'Active') AS active_members,
    (SELECT COUNT(*) FROM Transactions WHERE return_date IS NULL) AS currently_issued_books
FROM Books;

-- Demonstration Queries
SELECT '=== AVAILABLE BOOKS ===' AS info;
SELECT book_id, title, author, available_copies 
FROM Books WHERE available_copies > 0 ORDER BY title;

SELECT '=== TODAYS DUE BOOKS ===' AS info;
SELECT 
    t.transaction_id,
    m.full_name,
    b.title,
    t.due_date
FROM Transactions t
JOIN Members m ON t.member_id = m.member_id
JOIN Books b ON t.book_id = b.book_id
WHERE t.return_date IS NULL AND t.due_date = CURDATE();

SELECT '=== OVERDUE BOOKS ===' AS info;
SELECT 
    t.transaction_id,
    m.full_name,
    b.title,
    t.due_date,
    DATEDIFF(CURDATE(), t.due_date) AS days_overdue,
    (DATEDIFF(CURDATE(), t.due_date) * 10) AS calculated_fine
FROM Transactions t
JOIN Members m ON t.member_id = m.member_id
JOIN Books b ON t.book_id = b.book_id
WHERE t.return_date IS NULL AND t.due_date < CURDATE();

SELECT '=== LIBRARY STATISTICS ===' AS info;
SELECT * FROM LibraryStats;

SELECT '=== MEMBERS WITH PENDING FINES ===' AS info;
SELECT 
    m.member_id,
    m.full_name,
    SUM(t.fine_amount) AS total_fine
FROM Members m
JOIN Transactions t ON m.member_id = t.member_id
WHERE t.fine_amount > 0
GROUP BY m.member_id, m.full_name
HAVING total_fine > 0;

-- Test Stored Procedures
SELECT '=== TESTING STORED PROCEDURES ===' AS info;
CALL IssueBook(2, 3, CURDATE());
SELECT CalculateTotalFine(1) AS total_fine_for_rahul;
